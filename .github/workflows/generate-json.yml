name: Generate Images JSON

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate_json:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Create index.html and generate JSON
        run: |
          npm install sharp
          
          for dir in gallery_*/; do
            if [ -d "$dir" ]; then
              if [ ! -f "$dir/index.html" ]; then
                echo "Creating index.html for new gallery: $dir"
                cp .github/workflows/template_index.html "$dir/index.html"
              fi

              # Existing script to generate images.json
              node -e '
                const fs = require("fs");
                const path = require("path");
                const sharp = require("sharp");

                const galleryPath = process.argv[1];
                
                async function processGallery() {
                  const files = (await fs.promises.readdir(galleryPath))
                    .filter(file => file.toLowerCase().endsWith(".jpg") || file.toLowerCase().endsWith(".jpeg"))
                    .sort();
                  
                  const imageData = await Promise.all(files.map(async file => {
                    const filePath = path.join(galleryPath, file);
                    try {
                      const { dominant } = await sharp(filePath).stats();
                      const rgbColor = [dominant.r, dominant.g, dominant.b];
                      const hexColor = "#" + rgbColor.map(c => Math.round(c).toString(16).padStart(2, "0")).join("");
                      return { filename: file, avgColor: hexColor };
                    } catch (err) {
                      console.error(`Error processing ${file}:`, err);
                      return { filename: file, avgColor: "#e0e0e0" };
                    }
                  }));

                  await fs.promises.writeFile(
                    path.join(galleryPath, "images.json"),
                    JSON.stringify(imageData, null, 2)
                  );

                  console.log(`images.json for ${galleryPath} generated successfully.`);
                }
                
                processGallery();
              ' "$dir"
            fi
          done
      
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'Updated gallery files'
          file_pattern: 'gallery_*/index.html gallery_*/images.json'
